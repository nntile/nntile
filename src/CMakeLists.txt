# @copyright (c) 2022-present Skolkovo Institute of Science and Technology
#                              (Skoltech), Russia. All rights reserved.
#                2023-present Artificial Intelligence Research Institute
#                              (AIRI), Russia. All rights reserved.
#
# NNTile is software framework for fast training of big neural networks on
# distributed-memory heterogeneous systems based on StarPU runtime system.
#
# @file src/CMakeLists.txt
# Set NNTile sources to compile
#
# @version 1.1.0

# Base of the NNTile sources
set(BASE_SRC "context.cc")

# Ignore low-level kernel functions in case of SimGrid simulation
if(NOT HAVE_STARPU_SIMGRID)
    # Generic low-level CPU kernels
    set(KERNEL_CPU_SRC
        "kernel/accumulate_maxsumexp/cpu.cc"
        "kernel/accumulate_attn_output/cpu.cc"
        "kernel/adam_step/cpu.cc"
        "kernel/adamw_step/cpu.cc"
        "kernel/sgd_step/cpu.cc"
        "kernel/add/cpu.cc"
        "kernel/add_fiber/cpu.cc"
        "kernel/add_fiber_inplace/cpu.cc"
        "kernel/scale_fiber/cpu.cc"
        "kernel/add_inplace/cpu.cc"
        "kernel/add_slice/cpu.cc"
        "kernel/add_slice_inplace/cpu.cc"
        "kernel/cblas.cc"
        "kernel/conv2d_bwd_input_inplace/cpu.cc"
        "kernel/conv2d_bwd_weight_inplace/cpu.cc"
        "kernel/conv2d_inplace/cpu.cc"
        "kernel/embedding/cpu.cc"
        "kernel/embedding_backward/cpu.cc"
        "kernel/fill/cpu.cc"
        "kernel/gelu/cpu.cc"
        "kernel/gelu_inplace/cpu.cc"
        "kernel/gelu_backward/cpu.cc"
        "kernel/gelutanh/cpu.cc"
        "kernel/gelutanh_backward/cpu.cc"
        "kernel/gelutanh_inplace/cpu.cc"
        "kernel/hypot_inplace/cpu.cc"
        "kernel/hypot/cpu.cc"
        "kernel/hypot_scalar_inverse/cpu.cc"
        "kernel/logsumexp/cpu.cc"
        "kernel/mask_scalar/cpu.cc"
        "kernel/maxsumexp/cpu.cc"
        "kernel/norm/cpu.cc"
        "kernel/norm_fiber/cpu.cc"
        "kernel/norm_fiber_inplace/cpu.cc"
        "kernel/norm_slice_inplace/cpu.cc"
        "kernel/norm_slice/cpu.cc"
        "kernel/pow/cpu.cc"
        "kernel/multiply/cpu.cc"
        "kernel/multiply_fiber_inplace/cpu.cc"
        "kernel/multiply_fiber/cpu.cc"
        "kernel/multiply_inplace/cpu.cc"
        "kernel/multiply_slice/cpu.cc"
        "kernel/randn/cpu.cc"
        "kernel/relu_inplace/cpu.cc"
        "kernel/relu_backward/cpu.cc"
        "kernel/relu/cpu.cc"
        "kernel/rope/cpu.cc"
        "kernel/rope_backward/cpu.cc"
        "kernel/scale/cpu.cc"
        "kernel/scale_inplace/cpu.cc"
        "kernel/scale_slice/cpu.cc"
        "kernel/silu_backward/cpu.cc"
        "kernel/silu/cpu.cc"
        "kernel/silu_inplace/cpu.cc"
        "kernel/softmax/cpu.cc"
        "kernel/softmax_inplace/cpu.cc"
        "kernel/sqrt/cpu.cc"
        "kernel/sqrt_inplace/cpu.cc"
        "kernel/subcopy/cpu.cc"
        "kernel/subtract_indexed_outputs/cpu.cc"
        "kernel/sum_fiber/cpu.cc"
        "kernel/sum_slice/cpu.cc"
        "kernel/sum/cpu.cc"
        "kernel/sumprod_fiber/cpu.cc"
        "kernel/sumprod_slice/cpu.cc"
        "kernel/total_sum_accum/cpu.cc"
        "kernel/transpose/cpu.cc"
    )

    # CUDA-specific low-level kernels
    if(NNTILE_USE_CUDA)
        set(KERNEL_CUDA_SRC
            "kernel/accumulate_maxsumexp/cuda.cu"
            "kernel/accumulate_attn_output/cuda.cu"
            "kernel/adam_step/cuda.cu"
            "kernel/adamw_step/cuda.cu"
            "kernel/sgd_step/cuda.cu"
            "kernel/add/cuda.cu"
            "kernel/add_fiber/cuda.cu"
            "kernel/add_fiber_inplace/cuda.cu"
            "kernel/scale_fiber/cuda.cu"
            "kernel/add_inplace/cuda.cu"
            "kernel/add_slice/cuda.cu"
            "kernel/add_slice_inplace/cuda.cu"
            "kernel/cublas.cc"
            "kernel/conv2d_bwd_input_inplace/cuda.cu"
            "kernel/conv2d_bwd_weight_inplace/cuda.cu"
            "kernel/conv2d_inplace/cuda.cu"
            "kernel/embedding/cuda.cu"
            "kernel/embedding_backward/cuda.cu"
            "kernel/fill/cuda.cu"
            "kernel/gelu/cuda.cu"
            "kernel/gelu_inplace/cuda.cu"
            "kernel/gelu_backward/cuda.cu"
            "kernel/gelutanh/cuda.cu"
            "kernel/gelutanh_backward/cuda.cu"
            "kernel/gelutanh_inplace/cuda.cu"
            "kernel/hypot_inplace/cuda.cu"
            "kernel/hypot/cuda.cu"
            "kernel/hypot_scalar_inverse/cuda.cu"
            "kernel/logsumexp/cuda.cu"
            "kernel/mask_scalar/cuda.cu"
            "kernel/maxsumexp/cuda.cu"
            "kernel/norm/cuda.cu"
            "kernel/norm_fiber/cuda.cu"
            "kernel/norm_fiber_inplace/cuda.cu"
            "kernel/norm_slice_inplace/cuda.cu"
            "kernel/norm_slice/cuda.cu"
            "kernel/pow/cuda.cu"
            "kernel/multiply/cuda.cu"
            "kernel/multiply_fiber_inplace/cuda.cu"
            "kernel/multiply_fiber/cuda.cu"
            "kernel/multiply_inplace/cuda.cu"
            "kernel/multiply_slice/cuda.cu"
            "kernel/relu_inplace/cuda.cu"
            "kernel/relu_backward/cuda.cu"
            "kernel/relu/cuda.cu"
            "kernel/rope/cuda.cu"
            "kernel/rope_backward/cuda.cu"
            "kernel/scale/cuda.cu"
            "kernel/scale_inplace/cuda.cu"
            "kernel/scale_slice/cuda.cu"
            "kernel/silu_backward/cuda.cu"
            "kernel/silu/cuda.cu"
            "kernel/silu_inplace/cuda.cu"
            "kernel/softmax/cuda.cu"
            "kernel/softmax_inplace/cuda.cu"
            "kernel/sqrt/cuda.cu"
            "kernel/sqrt_inplace/cuda.cu"
            "kernel/subcopy/cuda.cu"
            "kernel/subtract_indexed_outputs/cuda.cu"
            "kernel/sum_fiber/cuda.cu"
            "kernel/sum_slice/cuda.cu"
            "kernel/sum/cuda.cu"
            "kernel/sumprod_fiber/cuda.cu"
            "kernel/sumprod_slice/cuda.cu"
            "kernel/total_sum_accum/cuda.cu"
            "kernel/transpose/cuda.cu"
            "kernel/flash_sdpa_fwd_cudnn/cuda.cc"
            "kernel/flash_sdpa_bwd_cudnn/cuda.cc"
        )
    endif(NNTILE_USE_CUDA)
endif(NOT HAVE_STARPU_SIMGRID)

# Basic StarPU-related sources
set(STARPU_BASE_SRC
    "starpu/handle.cc"
    "starpu/codelet.cc"
)

# StarPU-related wrappers (codelets) for low-level kernels
set(STARPU_CODELET_SRC
    "starpu/accumulate.cc"
    "starpu/accumulate_hypot.cc"
    "starpu/hypot.cc"
    "starpu/accumulate_maxsumexp.cc"
    "starpu/adam_step.cc"
    "starpu/adamw_step.cc"
    "starpu/sgd_step.cc"
    "starpu/add.cc"
    "starpu/add_fiber.cc"
    "starpu/add_fiber_inplace.cc"
    "starpu/scale_fiber.cc"
    "starpu/add_inplace.cc"
    "starpu/add_slice.cc"
    "starpu/add_slice_inplace.cc"
    "starpu/clear.cc"
    "starpu/conv2d_bwd_input_inplace.cc"
    "starpu/conv2d_bwd_weight_inplace.cc"
    "starpu/conv2d_inplace.cc"
    "starpu/copy.cc"
    "starpu/embedding.cc"
    "starpu/embedding_backward.cc"
    "starpu/fill.cc"
    "starpu/flash_sdpa_fwd_cudnn.cc"
    "starpu/flash_sdpa_bwd_cudnn.cc"
    "starpu/gelu.cc"
    "starpu/gelu_inplace.cc"
    "starpu/gelu_backward.cc"
    "starpu/gelutanh.cc"
    "starpu/gelutanh_backward.cc"
    "starpu/gelutanh_inplace.cc"
    "starpu/gemm.cc"
    "starpu/hypot_inplace.cc"
    "starpu/hypot_scalar_inverse.cc"
    "starpu/log_scalar.cc"
    "starpu/logsumexp.cc"
    "starpu/mask_scalar.cc"
    "starpu/maxsumexp.cc"
    "starpu/norm.cc"
    "starpu/norm_fiber.cc"
    "starpu/norm_fiber_inplace.cc"
    "starpu/norm_slice_inplace.cc"
    "starpu/norm_slice.cc"
    "starpu/pow.cc"
    "starpu/multiply.cc"
    "starpu/multiply_fiber_inplace.cc"
    "starpu/multiply_fiber.cc"
    "starpu/multiply_inplace.cc"
    "starpu/multiply_slice.cc"
    "starpu/randn.cc"
    "starpu/relu_inplace.cc"
    "starpu/relu_backward.cc"
    "starpu/relu.cc"
    "starpu/rope.cc"
    "starpu/rope_backward.cc"
    "starpu/scale.cc"
    "starpu/scale_inplace.cc"
    "starpu/scale_slice.cc"
    "starpu/silu_backward.cc"
    "starpu/silu.cc"
    "starpu/silu_inplace.cc"
    "starpu/softmax.cc"
    "starpu/softmax_inplace.cc"
    "starpu/sqrt.cc"
    "starpu/sqrt_inplace.cc"
    "starpu/subcopy.cc"
    "starpu/subtract_indexed_outputs.cc"
    "starpu/sum_fiber.cc"
    "starpu/sum_slice.cc"
    "starpu/sum.cc"
    "starpu/sumprod_fiber.cc"
    "starpu/sumprod_slice.cc"
    "starpu/total_sum_accum.cc"
    "starpu/transpose.cc"
)

# Basic Tile-related sources
set(TILE_BASE_SRC "tile/traits.cc")

# Tile-related operations
set(TILE_OPERATION_SRC
    "tile/adam_step.cc"
    "tile/adamw_step.cc"
    "tile/sgd_step.cc"
    "tile/add.cc"
    "tile/add_fiber.cc"
    "tile/add_fiber_inplace.cc"
    "tile/scale_fiber.cc"
    "tile/add_slice.cc"
    "tile/add_slice_inplace.cc"
    "tile/clear.cc"
    "tile/copy.cc"
    "tile/copy_intersection.cc"
    "tile/fill.cc"
    "tile/flash_sdpa_fwd_cudnn.cc"
    "tile/flash_sdpa_bwd_cudnn.cc"
    "tile/gelu.cc"
    "tile/gelu_inplace.cc"
    "tile/gelu_backward.cc"
    "tile/gelutanh.cc"
    "tile/gelutanh_backward.cc"
    "tile/gelutanh_inplace.cc"
    "tile/gemm.cc"
    "tile/hypot_inplace.cc"
    "tile/hypot.cc"
    "tile/logsumexp.cc"
    "tile/mask_scalar.cc"
    "tile/maxsumexp.cc"
    "tile/norm.cc"
    "tile/norm_fiber.cc"
    "tile/norm_fiber_inplace.cc"
    "tile/norm_slice_inplace.cc"
    "tile/norm_slice.cc"
    "tile/pow.cc"
    "tile/multiply_fiber_inplace.cc"
    "tile/multiply_fiber.cc"
    "tile/multiply_inplace.cc"
    "tile/multiply_slice.cc"
    "tile/randn.cc"
    "tile/relu_inplace.cc"
    "tile/relu_backward.cc"
    "tile/relu.cc"
    "tile/rope.cc"
    "tile/scale.cc"
    "tile/scale_inplace.cc"
    "tile/scale_slice.cc"
    "tile/silu_backward.cc"
    "tile/silu.cc"
    "tile/silu_inplace.cc"
    "tile/softmax.cc"
    "tile/softmax_inplace.cc"
    "tile/sqrt.cc"
    "tile/sqrt_inplace.cc"
    "tile/subtract_indexed_outputs.cc"
    "tile/sum_fiber.cc"
    "tile/sum_slice.cc"
    "tile/sum.cc"
    "tile/sumprod_fiber.cc"
    "tile/sumprod_slice.cc"
    "tile/total_sum_accum.cc"
)

# Tensor-related sources
set(TENSOR_BASE_SRC "tensor/traits.cc")

# Tensor-related operations
set(TENSOR_OPERATION_SRC
    "tensor/adam_step.cc"
    "tensor/adamw_step.cc"
    "tensor/sgd_step.cc"
    "tensor/add.cc"
    "tensor/add_fiber.cc"
    "tensor/add_fiber_inplace.cc"
    "tensor/scale_fiber.cc"
    "tensor/add_inplace.cc"
    "tensor/add_slice.cc"
    "tensor/add_slice_inplace.cc"
    "tensor/clear.cc"
    "tensor/conv2d_bwd_input_inplace.cc"
    "tensor/conv2d_bwd_weight_inplace.cc"
    "tensor/conv2d_inplace.cc"
    "tensor/copy.cc"
    "tensor/copy_intersection.cc"
    "tensor/distributions.cc"
    "tensor/embedding.cc"
    "tensor/embedding_backward.cc"
    "tensor/fill.cc"
    "tensor/flash_sdpa_fwd_cudnn.cc"
    "tensor/flash_sdpa_bwd_cudnn.cc"
    "tensor/gather.cc"
    "tensor/gelu.cc"
    "tensor/gelu_inplace.cc"
    "tensor/gelu_backward.cc"
    "tensor/gelutanh.cc"
    "tensor/gelutanh_backward.cc"
    "tensor/gelutanh_inplace.cc"
    "tensor/gemm.cc"
    "tensor/hypot_inplace.cc"
    "tensor/hypot.cc"
    "tensor/hypot_scalar_inverse.cc"
    "tensor/log_scalar.cc"
    "tensor/logsumexp.cc"
    "tensor/mask_scalar.cc"
    "tensor/maxsumexp.cc"
    "tensor/norm.cc"
    "tensor/norm_fiber.cc"
    "tensor/norm_fiber_inplace.cc"
    "tensor/norm_slice_inplace.cc"
    "tensor/norm_slice.cc"
    "tensor/pow.cc"
    "tensor/multiply.cc"
    "tensor/multiply_fiber_inplace.cc"
    "tensor/multiply_fiber.cc"
    "tensor/multiply_inplace.cc"
    "tensor/multiply_slice.cc"
    "tensor/randn.cc"
    "tensor/relu_inplace.cc"
    "tensor/relu_backward.cc"
    "tensor/relu.cc"
    "tensor/rope.cc"
    "tensor/rope_backward.cc"
    "tensor/scale.cc"
    "tensor/scale_inplace.cc"
    "tensor/scale_slice.cc"
    "tensor/scatter.cc"
    "tensor/silu_backward.cc"
    "tensor/silu_inplace.cc"
    "tensor/silu.cc"
    "tensor/softmax.cc"
    "tensor/softmax_inplace.cc"
    "tensor/sqrt.cc"
    "tensor/sqrt_inplace.cc"
    "tensor/subtract_indexed_outputs.cc"
    "tensor/sum_fiber.cc"
    "tensor/sum_slice.cc"
    "tensor/sum.cc"
    "tensor/sumprod_fiber.cc"
    "tensor/sumprod_slice.cc"
    "tensor/total_sum_accum.cc"
    "tensor/transpose.cc"
)

# Logger-related sources
set(LOGGER_SRC
    "logger/logger_thread.cc"
    "logger/websocket_client.cc"
)

# Graph-related sources
set(GRAPH_SRC
    "graph/logical_graph.cc"
    "graph/logical_graph_ops.cc"
    "graph/logical/gelu.cc"
    "graph/logical/gelu_inplace.cc"
    "graph/logical/gelu_backward.cc"
    "graph/logical/relu.cc"
    "graph/logical/relu_inplace.cc"
    "graph/logical/silu.cc"
    "graph/logical/sqrt.cc"
    "graph/logical/add.cc"
    "graph/logical/add_inplace.cc"
    "graph/logical/multiply.cc"
    "graph/logical/multiply_inplace.cc"
    "graph/logical/clear.cc"
    "graph/logical/softmax.cc"
    "graph/logical/softmax_inplace.cc"
    "graph/logical/pow.cc"
    "graph/logical/pow_inplace.cc"
    "graph/logical/hypot.cc"
    "graph/logical/hypot_inplace.cc"
    "graph/logical/hypot_scalar_inverse.cc"
    "graph/logical/fill.cc"
    "graph/logical/copy.cc"
    "graph/logical/transpose.cc"
    # "graph/logical/scatter.cc"
    # "graph/logical/copy_intersection.cc"
    "graph/logical/log_scalar.cc"
    "graph/logical/mask_scalar.cc"
    "graph/logical/subtract_indexed_outputs.cc"
    # "graph/logical/gather.cc"
    "graph/logical/scale_fiber.cc"
    "graph/logical/scale_slice.cc"
    "graph/logical/scale.cc"
    "graph/logical/scale_inplace.cc"
    "graph/logical/randn.cc"
    "graph/logical/sum.cc"
    "graph/logical/sum_fiber.cc"
    "graph/logical/sum_slice.cc"
    "graph/logical/norm.cc"
    "graph/logical/logsumexp.cc"
    "graph/logical/maxsumexp.cc"
    "graph/logical/total_sum_accum.cc"
    "graph/logical/sumprod_fiber.cc"
    "graph/logical/sumprod_slice.cc"
    "graph/logical/norm_fiber.cc"
    "graph/logical/norm_fiber_inplace.cc"
    "graph/logical/norm_slice.cc"
    "graph/logical/norm_slice_inplace.cc"
    "graph/logical/sgd_step.cc"
    "graph/logical/adam_step.cc"
    "graph/logical/adamw_step.cc"
    "graph/logical/flash_sdpa_fwd_cudnn.cc"
    "graph/logical/flash_sdpa_bwd_cudnn.cc"
    "graph/logical/rope.cc"
    "graph/logical/rope_backward.cc"
    "graph/logical/conv2d_inplace.cc"
    "graph/logical/conv2d_bwd_input_inplace.cc"
    "graph/logical/conv2d_bwd_weight_inplace.cc"
    "graph/logical/embedding.cc"
    "graph/logical/embedding_backward.cc"
    "graph/logical/gemm.cc"
    "graph/logical/add_fiber.cc"
    "graph/logical/add_fiber_inplace.cc"
    "graph/logical/add_slice.cc"
    "graph/logical/add_slice_inplace.cc"
    "graph/logical/multiply_fiber.cc"
    "graph/logical/multiply_fiber_inplace.cc"
    "graph/logical/multiply_slice.cc"
    "graph/logical/sqrt_inplace.cc"
    "graph/nn_graph.cc"
    "graph/compiled_graph.cc"
    "graph/compiled/add.cc"
    "graph/compiled/add_fiber.cc"
    "graph/compiled/add_fiber_inplace.cc"
    "graph/compiled/add_inplace.cc"
    "graph/compiled/add_slice.cc"
    "graph/compiled/add_slice_inplace.cc"
    "graph/compiled/adam_step.cc"
    "graph/compiled/adamw_step.cc"
    "graph/compiled/clear.cc"
    "graph/compiled/conv2d_bwd_input_inplace.cc"
    "graph/compiled/conv2d_bwd_weight_inplace.cc"
    "graph/compiled/conv2d_inplace.cc"
    "graph/compiled/copy.cc"
    # "graph/compiled/copy_intersection.cc"
    "graph/compiled/embedding.cc"
    "graph/compiled/embedding_backward.cc"
    "graph/compiled/fill.cc"
    "graph/compiled/flash_sdpa_bwd_cudnn.cc"
    "graph/compiled/flash_sdpa_fwd_cudnn.cc"
    # "graph/compiled/gather.cc"
    "graph/compiled/gelu.cc"
    "graph/compiled/gelu_backward.cc"
    "graph/compiled/gelu_inplace.cc"
    "graph/compiled/gelutanh.cc"
    "graph/compiled/gelutanh_backward.cc"
    "graph/compiled/gelutanh_inplace.cc"
    "graph/compiled/gemm.cc"
    "graph/compiled/hypot.cc"
    "graph/compiled/hypot_inplace.cc"
    "graph/compiled/hypot_scalar_inverse.cc"
    "graph/compiled/log_scalar.cc"
    "graph/compiled/logsumexp.cc"
    "graph/compiled/mask_scalar.cc"
    "graph/compiled/maxsumexp.cc"
    "graph/compiled/multiply.cc"
    "graph/compiled/multiply_fiber.cc"
    "graph/compiled/multiply_fiber_inplace.cc"
    "graph/compiled/multiply_inplace.cc"
    "graph/compiled/multiply_slice.cc"
    "graph/compiled/norm.cc"
    "graph/compiled/norm_fiber.cc"
    "graph/compiled/norm_fiber_inplace.cc"
    "graph/compiled/norm_slice.cc"
    "graph/compiled/norm_slice_inplace.cc"
    "graph/compiled/pow.cc"
    "graph/compiled/pow_inplace.cc"
    "graph/compiled/randn.cc"
    "graph/compiled/relu.cc"
    "graph/compiled/relu_backward.cc"
    "graph/compiled/relu_inplace.cc"
    "graph/compiled/rope.cc"
    "graph/compiled/rope_backward.cc"
    "graph/compiled/scale.cc"
    "graph/compiled/scale_fiber.cc"
    "graph/compiled/scale_inplace.cc"
    "graph/compiled/scale_slice.cc"
    # "graph/compiled/scatter.cc"
    "graph/compiled/sgd_step.cc"
    "graph/compiled/silu.cc"
    "graph/compiled/silu_backward.cc"
    "graph/compiled/silu_inplace.cc"
    "graph/compiled/softmax.cc"
    "graph/compiled/softmax_inplace.cc"
    "graph/compiled/sqrt.cc"
    "graph/compiled/sqrt_inplace.cc"
    "graph/compiled/subtract_indexed_outputs.cc"
    "graph/compiled/sum.cc"
    "graph/compiled/sum_fiber.cc"
    "graph/compiled/sum_slice.cc"
    "graph/compiled/sumprod_fiber.cc"
    "graph/compiled/sumprod_slice.cc"
    "graph/compiled/total_sum_accum.cc"
    "graph/compiled/transpose.cc"
)

# Module implementations
set(MODULE_SRC
    "module/module.cc"
    "module/gelu.cc"
    "module/mlp.cc"
    "module/linear.cc"
)

# Set the list of all sources
set(NNTILE_SRC
    ${BASE_SRC}
    ${KERNEL_CPU_SRC}
    ${KERNEL_CUDA_SRC}
    ${STARPU_BASE_SRC}
    ${STARPU_CODELET_SRC}
    ${TILE_BASE_SRC}
    ${TILE_OPERATION_SRC}
    ${TENSOR_BASE_SRC}
    ${TENSOR_OPERATION_SRC}
    ${GRAPH_SRC}
    ${MODULE_SRC}
    ${LOGGER_SRC}
)

target_sources(nntile PRIVATE ${NNTILE_SRC})
